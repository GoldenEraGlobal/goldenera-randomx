name: Build and Release

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build-randomx:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux - x86_64
          - os: ubuntu-latest
            arch: x86_64
            cmake_args: '-DCMAKE_BUILD_TYPE=Release -DARCH=native -DBUILD_SHARED_LIBS=ON -DCMAKE_C_FLAGS="-fPIC" -DCMAKE_SHARED_LINKER_FLAGS="-z noexecstack"'
            artifact_name: "librandomx_linux_x86_64.so"
            output_lib: "librandomx_linux_x86_64.so"
            source_lib: "librandomx.so"

          # macOS - x86_64
          - os: macos-13 # Intel-based runner
            arch: x86_64
            cmake_args: "-DCMAKE_BUILD_TYPE=Release -DARCH=native -DBUILD_SHARED_LIBS=ON"
            artifact_name: "librandomx_macos_x86_64.dylib"
            output_lib: "librandomx_macos_x86_64.dylib"
            source_lib: "librandomx.dylib"

          # Windows - x86_64
          - os: windows-latest
            arch: x86_64
            cmake_args: '-G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DARCH=native -DBUILD_SHARED_LIBS=ON'
            artifact_name: "librandomx_windows_x86_64.dll"
            output_lib: "librandomx_windows_x86_64.dll"
            source_lib: "librandomx.dll"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install mingw -y
        shell: pwsh

      - name: Compile RandomX
        run: |
          cd RandomX
          mkdir -p build
          cd build

          echo "Configuring RandomX for ${{ matrix.os }}"
          cmake .. ${{ matrix.cmake_args }}

          # Build
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cmake --build . --config Release -j 4
          else
            make -j4
          fi

          # Create target directory
          mkdir -p ../../src/main/resources/native

          # Copy library with verification
          echo "Looking for library: ${{ matrix.source_lib }}"
          ls -la

          if [ -f "${{ matrix.source_lib }}" ]; then
            cp -v "${{ matrix.source_lib }}" "../../src/main/resources/native/${{ matrix.output_lib }}"
            echo "âœ… Successfully copied ${{ matrix.source_lib }} to ${{ matrix.output_lib }}"
          else
            echo "âŒ Error: Library file ${{ matrix.source_lib }} not found!"
            echo "Contents of build directory:"
            ls -la
            exit 1
          fi

          echo "Contents of native resources directory:"
          ls -la ../../src/main/resources/native/
        shell: bash

      - name: Verify library file
        run: |
          echo "Verifying library file in native resources directory"
          if [ -f "src/main/resources/native/${{ matrix.output_lib }}" ]; then
            echo "âœ… Library file ${{ matrix.output_lib }} exists"
            file "src/main/resources/native/${{ matrix.output_lib }}" || true
          else
            echo "âŒ Library file ${{ matrix.output_lib }} is missing"
            echo "Contents of native directory:"
            ls -la src/main/resources/native/
            exit 1
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: src/main/resources/native/${{ matrix.output_lib }}
          if-no-files-found: error

  build-java:
    runs-on: ubuntu-latest
    needs: build-randomx
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Organize artifacts
        run: |
          mkdir -p src/main/resources/native/

          # Move all downloaded libraries to the native directory
          find artifacts/ -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) -exec cp -v {} src/main/resources/native/ \;

          echo "Downloaded artifacts:"
          ls -la src/main/resources/native/
        shell: bash

      - name: Check for Apple Silicon Library
        run: |
          echo "Checking for macOS ARM64 library (should be precompiled locally)"
          if [ -f "src/main/resources/native/librandomx_macos_aarch64.dylib" ]; then
            echo "âœ… Found precompiled Apple Silicon library"
          else
            echo "âš ï¸ WARNING: Apple Silicon library (librandomx_macos_aarch64.dylib) not found!"
            echo "âš ï¸ Please compile this library locally on an Apple Silicon Mac and commit it to the repository."
            echo "âš ï¸ Build will continue but the final JAR will not support Apple Silicon Macs."
          fi
        shell: bash

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests
        run: mvn test

      - name: Upload JAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            target/*.jar
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build-java
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Extract Version from pom.xml
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Extracted version: $VERSION"

      - name: Download JAR Artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts
          path: target/

      - name: Find Main JAR File
        id: find_jar
        run: |
          # Find the main JAR (exclude sources and javadoc)
          JAR_FILE=$(find target/ -type f -name "goldenera-randomx-*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "âŒ Error: No main JAR file found!"
            echo "Available files:"
            find target/ -type f -name "*.jar"
            exit 1
          fi

          echo "Found JAR file: $JAR_FILE"
          echo "jar_file=$JAR_FILE" >> $GITHUB_ENV

          JAR_BASENAME=$(basename "$JAR_FILE")
          echo "jar_basename=$JAR_BASENAME" >> $GITHUB_ENV

      - name: Generate Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # goldenera-randomx v${{ env.VERSION }}

          ## What's Included

          This release includes the Java library with native RandomX bindings for multiple platforms.

          ## Native Libraries Included

          - **Linux**: x86_64
          - **Windows**: x86_64
          - **macOS**: x86_64 (Intel), aarch64 (Apple Silicon)

          ## Installation

          Add to your Maven project:

          ```xml
          <dependency>
              <groupId>global.goldenera.randomx</groupId>
              <artifactId>goldenera-randomx</artifactId>
              <version>${{ env.VERSION }}</version>
          </dependency>
          ```

          Ensure you have the GitHub Package registry configured in your `pom.xml` or `settings.xml`.

          ## Performance Notes

          - **macOS Apple Silicon (M1/M2/M3)**: Use JIT + SECURE flags for optimal performance (~12x speedup)
          - All platforms support hardware AES acceleration when available
          EOF

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view "v${{ env.VERSION }}" > /dev/null 2>&1; then
            echo "release_exists=true" >> $GITHUB_ENV
            echo "âš ï¸ Release v${{ env.VERSION }} already exists"
          else
            echo "release_exists=false" >> $GITHUB_ENV
            echo "âœ… Release v${{ env.VERSION }} does not exist yet"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Delete existing release if it exists
        if: env.release_exists == 'true'
        run: |
          echo "Deleting existing release v${{ env.VERSION }}"
          gh release delete "v${{ env.VERSION }}" --yes --cleanup-tag
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release
        run: |
          gh release create "v${{ env.VERSION }}" \
            --title "goldenera-randomx v${{ env.VERSION }}" \
            --notes-file RELEASE_NOTES.md \
            "${{ env.jar_file }}#goldenera-randomx.jar"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Publish to GitHub Packages
        run: |
          echo "ðŸš€ Publishing JAR to GitHub Packages..."

          # We use deploy:deploy-file to upload the EXACT jar we built (with native libs)
          # instead of rebuilding it from source.
          mvn deploy:deploy-file \
            -DgroupId=global.goldenera.randomx \
            -DartifactId=goldenera-randomx \
            -Dversion=${{ env.VERSION }} \
            -Dpackaging=jar \
            -Dfile=${{ env.jar_file }} \
            -DpomFile=pom.xml \
            -DrepositoryId=github \
            -Durl=https://maven.pkg.github.com/GoldenEraGlobal/goldenera-randomx \
            -DretryFailedDeploymentCount=3
        env:
          # This token is automatically provided by GitHub Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
